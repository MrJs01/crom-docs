<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Importação de Arquivos - CROM Docs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #1a1d23; color: #e0e6eb; }
        .test-section { margin-bottom: 3rem; }
        .test-result { margin-top: 1rem; padding: 1rem; border-radius: 8px; }
        .test-success { background-color: rgba(25, 135, 84, 0.1); border: 1px solid rgba(25, 135, 84, 0.3); }
        .test-error { background-color: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); }
        .test-info { background-color: rgba(13, 110, 253, 0.1); border: 1px solid rgba(13, 110, 253, 0.3); }
        .file-drop-area { border: 2px dashed #6c757d; padding: 2rem; text-align: center; margin: 1rem 0; }
        .file-drop-area.drag-over { border-color: #0d6efd; background-color: rgba(13, 110, 253, 0.1); }
        pre { background-color: #2c3034; padding: 1rem; border-radius: 8px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-5">
            <i class="bi bi-file-earmark-arrow-up me-2"></i>
            Teste de Importação de Arquivos
        </h1>

        <!-- Teste de Carregamento de Bibliotecas -->
        <div class="test-section">
            <h2><i class="bi bi-gear me-2"></i>Teste de Carregamento de Bibliotecas</h2>
            <button class="btn btn-primary" id="test-libraries">Testar Bibliotecas</button>
            <div id="library-results" class="test-result d-none"></div>
        </div>

        <!-- Teste de Seleção de Arquivo -->
        <div class="test-section">
            <h2><i class="bi bi-file-earmark me-2"></i>Teste de Seleção de Arquivo</h2>
            <div class="file-drop-area" id="test-drop-area">
                <i class="bi bi-cloud-arrow-up display-1 text-secondary mb-3"></i>
                <p>Arraste e solte um arquivo aqui ou clique para selecionar</p>
                <input type="file" id="test-file-input" class="d-none" accept=".pdf,.doc,.docx,.html,.htm,.txt,.md,.markdown,.rtf">
            </div>
            <div id="file-info" class="test-result d-none"></div>
        </div>

        <!-- Teste de Processamento -->
        <div class="test-section">
            <h2><i class="bi bi-cpu me-2"></i>Teste de Processamento</h2>
            <button class="btn btn-success" id="test-process" disabled>Processar Arquivo</button>
            <div id="process-results" class="test-result d-none"></div>
        </div>

        <!-- Log de Atividades -->
        <div class="test-section">
            <h2><i class="bi bi-terminal me-2"></i>Log de Atividades</h2>
            <button class="btn btn-outline-secondary btn-sm" id="clear-log">Limpar Log</button>
            <pre id="activity-log" class="mt-2"></pre>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Importa as classes necessárias
        import FileImportManager from './js/managers/FileImportManager.js';
        import { formatFileSize, getFileIcon } from './js/utils/fileUtils.js';

        // Inicializa o gerenciador de importação
        const fileImportManager = new FileImportManager();
        let currentFile = null;

        // Elementos
        const testDropArea = document.getElementById('test-drop-area');
        const testFileInput = document.getElementById('test-file-input');
        const testLibrariesBtn = document.getElementById('test-libraries');
        const testProcessBtn = document.getElementById('test-process');
        const libraryResults = document.getElementById('library-results');
        const fileInfo = document.getElementById('file-info');
        const processResults = document.getElementById('process-results');
        const activityLog = document.getElementById('activity-log');
        const clearLogBtn = document.getElementById('clear-log');

        // Funções de log
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            activityLog.textContent += logEntry;
            activityLog.scrollTop = activityLog.scrollHeight;
            console.log(logEntry);
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `test-result test-${type}`;
            element.innerHTML = content;
            element.classList.remove('d-none');
        }

        // Teste de bibliotecas
        testLibrariesBtn.addEventListener('click', async () => {
            log('Iniciando teste de bibliotecas...');
            
            try {
                const supportedTypes = fileImportManager.getSupportedTypes();
                log(`Tipos suportados: ${Object.keys(supportedTypes).join(', ')}`);
                
                let libraryStatus = '<h5>Status das Bibliotecas:</h5><ul>';
                
                // Testa cada processador
                const processors = ['pdf', 'docx', 'html', 'txt', 'md', 'rtf'];
                
                for (const processor of processors) {
                    try {
                        await fileImportManager.loadProcessor(processor);
                        libraryStatus += `<li><i class="bi bi-check-circle text-success me-2"></i>${processor.toUpperCase()} - Carregado</li>`;
                        log(`Processador ${processor} carregado com sucesso`);
                    } catch (error) {
                        libraryStatus += `<li><i class="bi bi-x-circle text-danger me-2"></i>${processor.toUpperCase()} - Erro: ${error.message}</li>`;
                        log(`Erro ao carregar processador ${processor}: ${error.message}`, 'error');
                    }
                }
                
                libraryStatus += '</ul>';
                showResult('library-results', libraryStatus, 'success');
                
            } catch (error) {
                log(`Erro geral no teste de bibliotecas: ${error.message}`, 'error');
                showResult('library-results', `<strong>Erro:</strong> ${error.message}`, 'error');
            }
        });

        // Configuração do drag and drop
        testDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            testDropArea.classList.add('drag-over');
        });

        testDropArea.addEventListener('dragleave', () => {
            testDropArea.classList.remove('drag-over');
        });

        testDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            testDropArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelection(files[0]);
            }
        });

        testDropArea.addEventListener('click', () => {
            testFileInput.click();
        });

        testFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelection(e.target.files[0]);
            }
        });

        // Processamento de arquivo
        async function handleFileSelection(file) {
            log(`Arquivo selecionado: ${file.name} (${formatFileSize(file.size)})`);
            currentFile = file;
            
            // Validação
            const validation = fileImportManager.validateFile(file);
            if (!validation.valid) {
                log(`Arquivo inválido: ${validation.errors.join(', ')}`, 'error');
                showResult('file-info', `<strong>Erro:</strong> ${validation.errors.join(', ')}`, 'error');
                return;
            }

            // Informações do arquivo
            const fileInfoContent = `
                <h5>Informações do Arquivo:</h5>
                <ul>
                    <li><strong>Nome:</strong> ${file.name}</li>
                    <li><strong>Tamanho:</strong> ${formatFileSize(file.size)}</li>
                    <li><strong>Tipo:</strong> ${file.type || 'Desconhecido'}</li>
                    <li><strong>Suportado:</strong> ${fileImportManager.isSupported(file) ? 'Sim' : 'Não'}</li>
                </ul>
            `;
            
            showResult('file-info', fileInfoContent, 'info');
            testProcessBtn.disabled = false;
            
            log('Arquivo validado com sucesso');
        }

        // Teste de processamento
        testProcessBtn.addEventListener('click', async () => {
            if (!currentFile) {
                log('Nenhum arquivo selecionado', 'error');
                return;
            }

            log('Iniciando processamento do arquivo...');
            
            try {
                const result = await fileImportManager.processFile(currentFile);
                
                if (result.success) {
                    log('Arquivo processado com sucesso');
                    
                    const processContent = `
                        <h5>Resultado do Processamento:</h5>
                        <ul>
                            <li><strong>Título:</strong> ${result.title}</li>
                            <li><strong>Tipo:</strong> ${result.type}</li>
                            <li><strong>Tamanho do conteúdo:</strong> ${result.content.length} caracteres</li>
                        </ul>
                        <h6>Metadados:</h6>
                        <pre>${JSON.stringify(result.metadata, null, 2)}</pre>
                        <h6>Conteúdo (primeiros 500 caracteres):</h6>
                        <pre>${result.content.substring(0, 500)}${result.content.length > 500 ? '...' : ''}</pre>
                    `;
                    
                    showResult('process-results', processContent, 'success');
                    
                } else {
                    log(`Erro no processamento: ${result.error}`, 'error');
                    showResult('process-results', `<strong>Erro:</strong> ${result.error}`, 'error');
                }
                
            } catch (error) {
                log(`Erro no processamento: ${error.message}`, 'error');
                showResult('process-results', `<strong>Erro:</strong> ${error.message}`, 'error');
            }
        });

        // Limpar log
        clearLogBtn.addEventListener('click', () => {
            activityLog.textContent = '';
            log('Log limpo');
        });

        // Log inicial
        log('Página de teste carregada');
    </script>
</body>
</html>
